<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.7</storyId>
    <title>Implement Add New Server Workflow</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-7-implement-add-new-server-workflow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to click "+ Add Server" and fill out a form to create a new monitored server</iWant>
    <soThat>I can add infrastructure to monitoring in under 30 seconds</soThat>
    <tasks>
      - Task 1: Update "+ Add Server" button handler in Sidebar (wire click callback to parent)
      - Task 2: Implement "add mode" state management in MainPanel (mode state, empty form, auto-focus)
      - Task 3: Create backend API endpoint POST /api/config/servers (validation, duplicate ID check, atomic append)
      - Task 4: Implement frontend API service for createServer (POST request with ApiResponse handling)
      - Task 5: Wire create server handler in MainPanel (loading state, toast notifications, sidebar update)
      - Task 6: Implement server ID generation/validation strategy (uniqueness check, format validation)
      - Task 7: Add auto-focus to first form field (useRef + useEffect pattern)
      - Task 8: Handle post-save behavior (clear form for next add vs load new server)
      - Task 9: Update sprint-status.yaml (mark story as drafted)
      - Task 10: Test add new server workflow end-to-end (30-second target validation)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Given I am on the config page with the sidebar visible, when I click the "+ Add Server" button, then the right panel displays an empty server form with title "Add New Server"</criterion>
    <criterion id="AC2">And all form fields are empty (not pre-populated with dummy data)</criterion>
    <criterion id="AC3">And the Server ID field is editable (not disabled like in edit mode)</criterion>
    <criterion id="AC4">And focus is automatically set to the Server ID field for immediate typing</criterion>
    <criterion id="AC5">And I fill in required fields: Server ID, Server Name, IP Address, DNS Address</criterion>
    <criterion id="AC6">And I optionally expand and configure SNMP and NetApp sections</criterion>
    <criterion id="AC7">And when I click "Save Server", a POST /api/config/servers request is sent with new server data</criterion>
    <criterion id="AC8">And the backend validates the server configuration and checks for duplicate Server ID</criterion>
    <criterion id="AC9">And the backend appends the new server to servers.json atomically</criterion>
    <criterion id="AC10">And I see a success toast notification: "✓ Server added successfully"</criterion>
    <criterion id="AC11">And the new server appears in the sidebar list immediately</criterion>
    <criterion id="AC12">And the form either clears for another add OR loads the newly created server for editing (implementation choice)</criterion>
    <criterion id="AC13">And the entire workflow completes in under 30 seconds (UX requirement from PRD)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic and Story Breakdown</title>
        <section>Story 2.7: Implement Add New Server Workflow (lines 682-727)</section>
        <snippet>Story defines add server workflow with "+ Add Server" button triggering empty form, POST /api/config/servers backend endpoint, ID uniqueness validation, and 30-second UX target</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR5: Create new server with required fields</section>
        <snippet>System enables server creation with id, name, ip, dnsAddress fields. Success metric: 30-second server addition workflow</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Technical Architecture</title>
        <section>AD#6: REST API Endpoint Design</section>
        <snippet>POST endpoints for resource creation follow ApiResponse&lt;T&gt; pattern. Status codes: 201 Created (success), 400 (validation), 409 (duplicate), 500 (server error)</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Technical Architecture</title>
        <section>AD#4: Atomic File Writes</section>
        <snippet>Use writeConfigAtomic() utility for all config modifications. Pattern: write temp file → rename (atomic on POSIX). Prevents partial writes and corruption</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>5.1 Journey 2: Add New Server (lines 420-490)</section>
        <snippet>Add server workflow: Click "+ Add Server" → empty form opens → focus on Server ID → fill fields → click Save → toast + sidebar update. Target: under 30 seconds</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Add Server Workflow (line 382)</section>
        <snippet>POST /api/config/servers creates new server. Frontend sends empty form data, backend validates uniqueness, appends to array, returns new server object</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/2-6-implement-save-server-functionality-with-backend-api.md</path>
        <title>Story 2.6: Implement Save Server Functionality (Completed)</title>
        <section>Dev Notes - Learnings</section>
        <snippet>Atomic write pattern ready (fileUtils.ts), validation utility ready (validation.ts), toast notifications configured with duration support, ApiResponse&lt;T&gt; pattern established</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>backend/src/utils/fileUtils.ts</path>
        <kind>utility</kind>
        <symbol>writeConfigAtomic</symbol>
        <lines>16-35</lines>
        <reason>Reuse for atomic append operation when adding new server to servers.json</reason>
      </artifact>
      <artifact>
        <path>backend/src/utils/validation.ts</path>
        <kind>utility</kind>
        <symbol>validateServerConfig</symbol>
        <lines>14-109</lines>
        <reason>Reuse for server configuration validation. Add new function checkDuplicateServerId() for uniqueness check</reason>
      </artifact>
      <artifact>
        <path>backend/src/routes/config.ts</path>
        <kind>route</kind>
        <symbol>PUT /api/config/servers/:id</symbol>
        <lines>124-205</lines>
        <reason>Reference for POST endpoint pattern. Similar structure: validate → read servers.json → modify array → atomic write → return ApiResponse</reason>
      </artifact>
      <artifact>
        <path>src/services/api.ts</path>
        <kind>service</kind>
        <symbol>configApi.updateServer</symbol>
        <lines>257-283</lines>
        <reason>Reference for createServer method. Similar pattern: POST request → parse ApiResponse → throw on error → return data</reason>
      </artifact>
      <artifact>
        <path>src/components/config/MainPanel.tsx</path>
        <kind>component</kind>
        <symbol>MainPanel</symbol>
        <lines>1-200</lines>
        <reason>Core component to modify. Add mode state, handleAddServer function, handleSaveNewServer function, auto-focus logic</reason>
      </artifact>
      <artifact>
        <path>src/components/config/Sidebar.tsx</path>
        <kind>component</kind>
        <symbol>Sidebar</symbol>
        <lines>1-100</lines>
        <reason>Wire "+ Add Server" button onClick to parent callback prop (onAddServerClick)</reason>
      </artifact>
      <artifact>
        <path>src/components/config/ConfigPage.tsx</path>
        <kind>component</kind>
        <symbol>ConfigPage</symbol>
        <lines>1-50</lines>
        <reason>Route callback from Sidebar to MainPanel. Pass onAddServerClick down to Sidebar, wire to MainPanel.handleAddServer</reason>
      </artifact>
      <artifact>
        <path>src/components/config/sections/BasicServerInfoSection.tsx</path>
        <kind>component</kind>
        <symbol>BasicServerInfoSection</symbol>
        <lines>1-100</lines>
        <reason>Accept ref prop for Server ID input to enable auto-focus in add mode</reason>
      </artifact>
      <artifact>
        <path>src/hooks/use-toast.ts</path>
        <kind>hook</kind>
        <symbol>useToast</symbol>
        <lines>1-200</lines>
        <reason>Reuse for success/error toast notifications with duration support (3s auto-dismiss for success, Infinity for errors)</reason>
      </artifact>
      <artifact>
        <path>src/types/server.ts</path>
        <kind>type</kind>
        <symbol>ServerConfig</symbol>
        <lines>1-50</lines>
        <reason>Use interface to create empty server template for add mode initial state</reason>
      </artifact>
    </code>

    <dependencies>
      <nodejs>
        <package name="express" version="^4.18.0">Backend HTTP framework</package>
        <package name="react" version="^18.2.0">Frontend UI library</package>
        <package name="typescript" version="^5.0.0">Type checking</package>
      </nodejs>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">All API endpoints must return ApiResponse&lt;T&gt; format: {success: true, data: T} | {success: false, error: string, validationErrors?: Record&lt;string, string&gt;}</constraint>
    <constraint type="architecture">All configuration file writes must use writeConfigAtomic() utility to prevent corruption</constraint>
    <constraint type="ux">Add server workflow must complete in under 30 seconds (measured from button click to server in sidebar)</constraint>
    <constraint type="validation">Server ID must be unique across all servers (409 Conflict if duplicate)</constraint>
    <constraint type="validation">Server ID format: lowercase letters, numbers, hyphens only. Pattern: /^[a-z0-9-]+$/. Length: 3-50 characters</constraint>
    <constraint type="validation">Required fields: id, name, ip, dns must be present and non-empty</constraint>
    <constraint type="validation">IP address must match IPv4 format: /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/</constraint>
    <constraint type="behavior">Server ID field must be editable in add mode, disabled in edit mode</constraint>
    <constraint type="behavior">Auto-focus Server ID field when entering add mode (UX requirement)</constraint>
    <constraint type="behavior">Toast notifications: Success auto-dismiss after 3 seconds, errors persist until dismissed</constraint>
    <constraint type="implementation">Reuse existing form components from Stories 2.2-2.5 (BasicServerInfoSection, SNMPConfigSection, NetAppConfigSection)</constraint>
    <constraint type="implementation">No breaking changes to existing edit workflow (Story 2.6)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/config/servers</name>
      <kind>REST endpoint</kind>
      <signature>
        Request: POST /api/config/servers
        Body: ServerConfig (JSON)
        Response: ApiResponse&lt;ServerConfig&gt;
        Status Codes:
          - 201 Created: Server added successfully
          - 400 Bad Request: Validation errors (invalid format, missing required fields)
          - 409 Conflict: Duplicate server ID
          - 500 Internal Server Error: File write failure
      </signature>
      <path>backend/src/routes/config.ts (to be added)</path>
    </interface>
    <interface>
      <name>configApi.createServer</name>
      <kind>Frontend API service</kind>
      <signature>
        async createServer(data: ServerConfig): Promise&lt;ServerConfig&gt;
        - Makes POST request to /api/config/servers
        - Parses ApiResponse&lt;ServerConfig&gt;
        - Throws error if response.success === false
        - Returns server data on success
      </signature>
      <path>src/services/api.ts (to be added)</path>
    </interface>
    <interface>
      <name>MainPanel.handleAddServer</name>
      <kind>React component method</kind>
      <signature>
        const handleAddServer = () =&gt; void
        - Sets mode to 'add'
        - Clears selectedServerId
        - Initializes formData with empty ServerConfig template
        - Triggers auto-focus on Server ID field via useEffect
      </signature>
      <path>src/components/config/MainPanel.tsx (to be added)</path>
    </interface>
    <interface>
      <name>MainPanel.handleSaveNewServer</name>
      <kind>React component method</kind>
      <signature>
        const handleSaveNewServer = async () =&gt; Promise&lt;void&gt;
        - Sets loading state
        - Calls configApi.createServer(formData)
        - On success: shows toast, updates sidebar, clears form or loads new server
        - On error: shows error toast, keeps form editable
        - Finally: clears loading state
      </signature>
      <path>src/components/config/MainPanel.tsx (to be added)</path>
    </interface>
    <interface>
      <name>checkDuplicateServerId</name>
      <kind>Validation function</kind>
      <signature>
        async checkDuplicateServerId(id: string, configPath: string): Promise&lt;boolean&gt;
        - Reads servers.json
        - Checks if any server has matching id
        - Returns true if duplicate found, false otherwise
      </signature>
      <path>backend/src/utils/validation.ts (to be added)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Tests follow manual QA approach for MVP. TypeScript compilation (npm run build) serves as static type checking. End-to-end workflow testing validates acceptance criteria. Future enhancement: Jest unit tests for utilities, React Testing Library for components, Playwright for E2E automation.
    </standards>

    <locations>
      - Backend: backend/src/**/*.test.ts (future)
      - Frontend: src/**/*.test.tsx (future)
      - E2E: tests/e2e/**/*.spec.ts (future)
    </locations>

    <ideas>
      <test ac="AC1">Click "+ Add Server" button → verify MainPanel displays "Add New Server" title and empty form</test>
      <test ac="AC2">Verify all form fields are empty (not pre-populated) in add mode</test>
      <test ac="AC3">Verify Server ID field is editable (not disabled) in add mode</test>
      <test ac="AC4">Verify focus automatically moves to Server ID field when entering add mode</test>
      <test ac="AC5,AC7">Fill required fields → click Save → verify POST /api/config/servers sent with correct data</test>
      <test ac="AC8">Try to add server with duplicate ID → verify 409 error and inline error message "Server ID already exists"</test>
      <test ac="AC9">Verify new server appended to backend/servers.json after successful save</test>
      <test ac="AC10">Verify success toast appears with message "✓ Server added successfully" and auto-dismisses after 3 seconds</test>
      <test ac="AC11">Verify new server appears in sidebar list immediately after save</test>
      <test ac="AC12">Verify post-save behavior matches implementation choice (form clears or loads new server)</test>
      <test ac="AC13">Time workflow from "+ Add Server" click to server in sidebar → verify &lt;30 seconds</test>
      <test edge-case="validation">Enter invalid IP (999.999.999.999) → verify validation error and Save button disabled/blocked</test>
      <test edge-case="validation">Leave required fields empty → verify validation errors on save attempt</test>
      <test edge-case="error-handling">Stop backend → try to add server → verify error toast persists and form remains editable</test>
      <test integration="typescript">Run npm run build → verify zero TypeScript compilation errors</test>
    </ideas>
  </tests>
</story-context>

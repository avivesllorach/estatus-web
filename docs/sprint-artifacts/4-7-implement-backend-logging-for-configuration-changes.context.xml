<story-context id="4-7-implement-backend-logging-for-configuration-changes" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>7</storyId>
    <title>Implement Backend Logging for Configuration Changes</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-25T12:00:00.000Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-7-implement-backend-logging-for-configuration-changes.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>all configuration changes logged with timestamps</iWant>
    <soThat>I can audit what changed and when for debugging</soThat>
    <tasks>5 main tasks: 1) Set up structured logging infrastructure with Winston/console logging, 2) Add logging to server CRUD endpoints with before/after state comparison, 3) Add logging to group CRUD endpoints with server assignment tracking, 4) Implement validation failure logging with field-level details, 5) Create security-conscious logging with credential masking</tasks>
  </story>

  <acceptanceCriteria>1. Backend logs configuration changes with timestamp, action type (ADDED/UPDATED/DELETED), resource type (SERVER/GROUP), resource ID, and change summary
2. Logs written in consistent JSON/structured format to console/log files
3. Validation failures logged with detailed context and field-level information
4. Logs include debugging context without exposing sensitive data (passwords, credentials)
5. Logs capture before/after file write operations for complete audit trail</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/prd.md" title="Product Requirements Document" section="NFR-M3 Error Logging" snippet="Backend must log all configuration changes with timestamps. Validation failures must be logged with details." />
      <doc path="docs/architecture.md" title="System Architecture" section="Error Handling" snippet="Backend: Always try-catch file I/O, log with context, return ApiResponse. Never expose internal errors to user (sanitize messages)" />
      <doc path="docs/architecture.md" title="System Architecture" section="Logging" snippet="Use structured logging (JSON context objects). Levels: INFO (operations), ERROR (failures), WARN (data issues), DEBUG (development). Always log: Config changes, file operations, validation failures, SSE broadcasts. Never log sensitive data (passwords, credentials)" />
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 4.7" snippet="Use consistent logging library (Winston, Pino, or console with structure). Log before and after file writes. Include enough context for debugging without sensitive data." />
    </docs>
    <code>
      <artifact path="backend/src/routes/config.ts" kind="route" symbol="router" lines="1-50" reason="Main configuration CRUD endpoints that need logging integration - contains POST/PUT/DELETE for servers and groups" />
      <artifact path="backend/src/services/ConfigManager.ts" kind="service" symbol="ConfigManager" lines="1-30" reason="Event-driven configuration management service - should emit logging events for configuration changes" />
      <artifact path="backend/src/utils/fileUtils.ts" kind="utility" symbol="writeConfigAtomic" lines="16-56" reason="Atomic file write function - needs before/after logging integration for audit trail" />
      <artifact path="backend/src/config/constants.ts" kind="config" symbol="constants" reason="Application constants - location for logging configuration constants" />
      <artifact path="backend/src/utils/validation.ts" kind="utility" symbol="validateServerConfig" reason="Validation utilities - need enhanced error logging for validation failures" />
    </code>
    <dependencies>
      <ecosystem name="Node.js">
        <package name="express" version="^4.18.2" purpose="Web framework for API endpoints" />
        <package name="cors" version="^2.8.5" purpose="Cross-origin resource sharing" />
        <package name="net-snmp" version="^3.23.0" purpose="SNMP monitoring" />
        <package name="ping" version="^0.4.4" purpose="Server ping monitoring" />
      </ecosystem>
      <ecosystem name="DevDependencies">
        <package name="typescript" version="^5.3.3" purpose="TypeScript compiler" />
        <package name="jest" version="^30.2.0" purpose="Testing framework" />
        <package name="uuid" version="^13.0.0" purpose="UUID generation for logging" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture" description="Follow existing error handling patterns: wrap all file I/O in try-catch, log with context, return ApiResponse format" />
    <constraint type="security" description="Never log sensitive data: passwords, SNMP community strings, NetApp credentials. Create sanitization utility to mask these fields" />
    <constraint type="performance" description="Logging must not disrupt hot-reload functionality or monitoring continuity. Keep logging operations lightweight" />
    <constraint type="compatibility" description="Maintain existing API response format (ApiResponse&lt;T&gt;). Logging should be internal and not affect client responses" />
    <constraint type="testing" description="Include comprehensive unit tests for logging utilities and integration tests for endpoint logging" />
    <constraint type="format" description="Use structured JSON logging format with consistent fields: timestamp, level, action, resource, context" />
  </constraints>

  <interfaces>
    <interface name="Logging Utility" kind="utility" signature="logger.info(message: string, context: object)" path="backend/src/utils/logger.ts" />
    <interface name="Log Sanitizer" kind="utility" signature="sanitizeConfig(config: object): object" path="backend/src/utils/logger.ts" />
    <interface name="Config CRUD Endpoints" kind="REST" signature="POST /api/config/servers, PUT /api/config/servers/:id, DELETE /api/config/servers/:id" path="backend/src/routes/config.ts" />
    <interface name="Group CRUD Endpoints" kind="REST" signature="POST /api/config/groups, PUT /api/config/groups/:id, DELETE /api/config/groups/:id" path="backend/src/routes/config.ts" />
    <interface name="Atomic File Write" kind="function" signature="writeConfigAtomic(filePath: string, data: any): Promise<void>" path="backend/src/utils/fileUtils.ts" />
  </interfaces>

  <tests>
    <standards>Backend uses Jest testing framework with TypeScript support. Tests located in src/**/__tests__/ directories. Test files use .test.ts extension. Follow existing patterns: unit tests for utilities, integration tests for API endpoints, and mock file system operations for file utilities testing.</standards>
    <locations>backend/src/utils/__tests__/logger.test.ts, backend/src/routes/__tests__/config.test.ts, backend/src/utils/__tests__/validation.test.ts, backend/src/services/__tests__/ConfigManager.test.ts</locations>
    <ideas>
      <test idea="LogSanitizer utility masks passwords and credentials while preserving other fields" acceptanceCriteria="4" />
      <test idea="ConfigManager.emit() events are logged with proper timestamps and context" acceptanceCriteria="1" />
      <test idea="Server CRUD endpoints log before/after state changes for updates" acceptanceCriteria="1,5" />
      <test idea="Group CRUD endpoints log server assignment changes" acceptanceCriteria="1" />
      <test idea="Validation failures logged with field-level error details" acceptanceCriteria="3" />
      <test idea="File write operations logged with before/after state" acceptanceCriteria="5" />
    </ideas>
  </tests>
</story-context>
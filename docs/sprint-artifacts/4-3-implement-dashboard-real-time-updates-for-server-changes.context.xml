<story-context id="4-3-implement-dashboard-real-time-updates-for-server-changes" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Implement Dashboard Real-Time Updates for Server Changes</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-3-implement-dashboard-real-time-updates-for-server-changes.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user viewing the dashboard</asA>
    <iWant>the dashboard to update automatically when servers are added/removed/updated</iWant>
    <soThat>I always see the current monitoring state without refreshing</soThat>
    <tasks>
- Task 1: Extend EventSource listener for new configuration event types (AC: 1,2,3,4)
  - Add event handlers for serverAdded, serverRemoved, serverUpdated, groupsChanged
  - Integrate with existing EventSource infrastructure
- Task 2: Implement dynamic server card management (AC: 1,2,3)
  - Create ServerContainer component addition/removal logic
  - Handle server data updates without destroying/recreating components
  - Position new servers in appropriate groups
- Task 3: Implement group layout reorganization (AC: 4)
  - Re-render group structure when groupsChanged event received
  - Maintain existing ServerContainer instances during reorganization
  - Animate layout transitions smoothly
- Task 4: Ensure smooth visual transitions (AC: 5)
  - Add CSS transitions for server card additions/removals
  - Prevent layout flash during group reorganization
  - Test for visual continuity during rapid changes
- Task 5: Maintain monitoring continuity (AC: 6)
  - Ensure statusChange and diskUpdate events continue during layout updates
  - Test monitoring stream integrity during server additions/removals
  - Verify no data loss during group reorganization
    </tasks>
  </story>

  <acceptanceCriteria>
1. Dashboard adds new server card when `serverAdded` SSE event received
2. Dashboard removes server card when `serverRemoved` SSE event received
3. Dashboard updates server details when `serverUpdated` SSE event received
4. Dashboard reorganizes layout when `groupsChanged` SSE event received
5. All updates happen smoothly without full page refresh
6. Monitoring data (ping status, disk info) continues updating during layout changes
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epic 4.3 Specification" section="Story 4.3: Implement Dashboard Real-Time Updates for Server Changes" snippet="Update existing dashboard EventSource listener to handle new event types, Add/remove/update ServerContainer components dynamically, Re-render group layout when groupsChanged received"/>
      <doc path="docs/sprint-artifacts/4-2-extend-sse-events-for-configuration-changes.md" title="Previous Story SSE Events" section="SSE Event Types" snippet="Backend broadcasts SSE events: serverAdded, serverUpdated, serverRemoved, groupsChanged to all connected clients via /api/events endpoint"/>
    </docs>
    <code>
      <file path="src/components/Dashboard.tsx" kind="component" symbol="Dashboard" lines="1-50" reason="Main dashboard container with existing SSE connection and server state management">
        Uses apiService.connectToStatusUpdates() for real-time updates, manages ServerData[] state, groups servers using createContainerGroups()
      </file>
      <file path="src/components/ServerContainer.tsx" kind="component" symbol="ServerContainer" lines="1-30" reason="Server group container component that needs dynamic updates for server additions/removals">
        Displays groups of servers in grid layout, handles serverCount prop for responsive design
      </file>
      <file path="src/components/DeviceCard.tsx" kind="component" symbol="DeviceCard" lines="1-40" reason="Individual server card component that needs to handle data updates without recreation">
        Shows server name, IP, online status, and disk info with color-coded usage levels
      </file>
      <file path="src/services/api.ts" kind="service" symbol="ApiService" lines="150-200" reason="Core SSE service that needs extension for configuration change events">
        Current EventMessage types: connected, initial, statusChange, diskUpdate, heartbeat. Uses Map<string, ServerData> for state management
      </file>
      <file path="src/types/server.ts" kind="types" symbol="ServerData, ServerStatus, DiskInfo" lines="1-50" reason="Type definitions for server data structures used in SSE events">
        Defines ServerConfig, ServerStatus, and DiskInfo interfaces for type safety
      </file>
      <file path="src/types/group.ts" kind="types" symbol="GroupConfig" lines="1-20" reason="Type definitions for group configuration used in layout reorganization">
        Defines GroupConfig with id, name, order, and serverIds array
      </file>
    </code>
    <dependencies>
      <ecosystem name="React">
        <package name="react" version="18.2.0" reason="Core UI framework with hooks for state management"/>
        <package name="react-dom" version="18.2.0" reason="DOM rendering for React components"/>
        <package name="react-router-dom" version="7.9.6" reason="Navigation between dashboard and config pages"/>
        <package name="typescript" version="5.2.2" reason="Type safety and interface definitions"/>
      </ecosystem>
      <ecosystem name="UI Components">
        <package name="@radix-ui/react-toast" version="1.2.15" reason="Toast notifications for configuration change feedback"/>
        <package name="lucide-react" version="0.554.0" reason="Icons for server status and loading indicators"/>
        <package name="tailwindcss-animate" version="1.0.7" reason="CSS animations for smooth transitions"/>
      </ecosystem>
      <ecosystem name="Styling">
        <package name="tailwindcss" version="3.4.3" reason="Utility-first CSS framework with transition utilities"/>
        <package name="tailwind-merge" version="3.4.0" reason="Merging Tailwind class names safely"/>
        <package name="class-variance-authority" version="0.7.1" reason="Component variant management"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Extend existing `/api/events` SSE endpoint usage in dashboard component</constraint>
    <constraint>Reuse ServerContainer component pattern from current dashboard implementation</constraint>
    <constraint>Maintain existing state management for server monitoring data using Map&lt;string, ServerData&gt;</constraint>
    <constraint>Follow established component hierarchy: Dashboard → ServerContainer → DeviceCard</constraint>
    <constraint>Preserve existing accessibility patterns (aria-current, role, tabIndex) during dynamic updates</constraint>
    <constraint>Use existing CSS animation patterns with tailwindcss-animate for smooth transitions</constraint>
    <constraint>Leverage current EventMessage interface structure for new event types: serverAdded, serverUpdated, serverRemoved, groupsChanged</constraint>
    <constraint>Maintain backward compatibility with existing statusChange and diskUpdate events</constraint>
  </constraints>
  <interfaces>
    <interface name="EventMessage" kind="TypeScript Interface" signature="interface EventMessage { type: 'connected' | 'initial' | 'statusChange' | 'diskUpdate' | 'heartbeat' | 'serverAdded' | 'serverUpdated' | 'serverRemoved' | 'groupsChanged'; message?: string; servers?: ServerData[]; update?: StatusUpdate | DiskUpdate | ServerData; timestamp?: string; }" path="src/services/api.ts"/>
    <interface name="ApiService.connectToStatusUpdates" kind="Method Signature" signature="connectToStatusUpdates(callback: (servers: ServerData[]) =&gt; void): void" path="src/services/api.ts"/>
    <interface name="ServerData" kind="TypeScript Interface" signature="interface ServerData { id: string; name: string; ip: string; isOnline: boolean; consecutiveSuccesses: number; consecutiveFailures: number; lastChecked: string; lastStatusChange: string; diskInfo?: DiskInfo[]; }" path="src/types/server.ts"/>
    <interface name="GroupConfig" kind="TypeScript Interface" signature="interface GroupConfig { id: string; name: string; order: number; serverIds: string[]; }" path="src/types/group.ts"/>
  </interfaces>
  <tests>
    <standards>Use React Testing Library for component testing with mock EventSource, test SSE event handling with mock WebSocket connections, verify component state updates match event data structure, test edge cases: rapid events, invalid event data, network interruptions, ensure accessibility during dynamic updates (ARIA live regions for screen readers), performance testing with large numbers of servers (>50), maintain existing ESLint and TypeScript strict mode compliance</standards>
    <locations>Unit tests in src/components/__tests__/Dashboard.test.tsx, integration tests for SSE event handling in src/services/__tests__/api.test.ts, visual regression tests for layout transitions, accessibility tests with axe-core integration</locations>
    <ideas>
      <idea ac="1">Mock serverAdded SSE event and verify new ServerContainer component appears in correct group with smooth animation</idea>
      <idea ac="2">Mock serverRemoved SSE event and verify server card disappears cleanly with fade-out animation without affecting other cards</idea>
      <idea ac="3">Mock serverUpdated SSE event and verify existing DeviceCard updates data (name, IP, status) without component recreation</idea>
      <idea ac="4">Mock groupsChanged SSE event and verify layout reorganizes servers into new groups while maintaining monitoring streams and active status</idea>
      <idea ac="5">Test rapid succession of configuration events (add, update, remove) to ensure smooth transitions without layout flash or state inconsistency</idea>
      <idea ac="6">Verify existing statusChange and diskUpdate events continue processing during configuration layout updates without data loss</idea>
      <idea ac="7">Test accessibility: ensure aria-current attributes update correctly during server additions/removals and focus management works properly</idea>
      <idea ac="8">Performance test: simulate 100+ servers with rapid configuration changes to ensure UI remains responsive</idea>
    </ideas>
  </tests>
</story-context>
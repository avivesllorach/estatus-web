<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Implement Server Selection with Active State</title>
    <status>drafted</status>
    <generatedAt>2025-11-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-implement-server-selection-with-active-state.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to click a server in the sidebar and see it highlighted</iWant>
    <soThat>I know which server I'm currently viewing/editing</soThat>
    <tasks>
- Task 1: Implement selection state management in ConfigPage (AC: 1, 2, 3)
  - Add `selectedServerId` state variable to ConfigPage component
  - Add `selectedGroupId` state variable (for future group selection)
  - Create handler function `handleSelectServer(id: string)` to update state
  - Ensure selecting a server clears group selection (mutual exclusivity)
  - Pass state and handler as props to Sidebar component

- Task 2: Update ServerListItem to support active state styling (AC: 1, 2)
  - Add `isActive` boolean prop to ServerListItem component
  - Apply conditional styling: blue background (#eff6ff) when active
  - Apply conditional styling: blue text (#2563eb) when active
  - Maintain hover state for non-active items
  - Ensure active state overrides hover state visually

- Task 3: Connect click handling in Sidebar to selection state (AC: 1, 2, 3)
  - Pass `onSelectServer` handler from ConfigPage to Sidebar
  - Pass `selectedServerId` from ConfigPage to Sidebar
  - In Sidebar, map servers and determine `isActive` for each item
  - Pass `isActive` and `onClick` props to each ServerListItem
  - Verify clicking a server updates selection state correctly

- Task 4: Implement keyboard navigation for server list (AC: 4, 5)
  - Add keyboard event handler for Arrow Up/Down keys
  - Implement focus management to track highlighted server
  - Add Enter key handler to select highlighted server
  - Ensure Tab key navigates to next focusable element (natural tab order)
  - Add `aria-current="true"` attribute to active server item
  - Add appropriate ARIA roles and labels for screen reader support

- Task 5: Test and verify selection behavior (AC: All)
  - Test clicking different servers updates active state
  - Test only one server is active at a time
  - Test active state persists when navigating away and back
  - Test keyboard navigation (arrows, enter, tab)
  - Test ARIA attributes with screen reader or accessibility inspector
  - Verify visual design matches UX spec (colors, spacing)
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Given** I am on the `/config` page with servers listed
   **When** I click a server in the sidebar
   **Then** that server is highlighted with blue background (#eff6ff) and blue text (#2563eb)

2. **And** only one server can be active at a time (clicking another deselects previous)

3. **And** the active selection persists until I select a different server or group

4. **And** keyboard navigation is supported:
   - Arrow Up/Down to navigate server list
   - Enter to select highlighted server
   - Tab order follows visual hierarchy

5. **And** active server has `aria-current="true"` for screen readers
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>7.1 Navigation Patterns - Active State</section>
        <snippet>Active State Indication: Visual: Blue background (#eff6ff), blue text (#2563eb). Persistent: Active item stays highlighted until another selected. Clear: Only one active item at a time.</snippet>
      </artifact>
      <artifact>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>8.2 Keyboard Navigation</section>
        <snippet>Focus Management: Visible focus indicators (2px blue ring around focused elements). Tab order: Logical flow (sidebar → header → form fields → buttons). aria-current: Mark active server selection in list.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Decision 10: State Management Approach</section>
        <snippet>React useState for selection state (simple, no global state library needed). Lift state to ConfigPage (common parent for Sidebar and future MainPanel form). Props drilling acceptable for small component tree (3 levels deep max).</snippet>
      </artifact>
      <artifact>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.4: Implement Server Selection with Active State</section>
        <snippet>User wants to click a server in the sidebar and see it highlighted, so that they know which server they're currently viewing/editing. Epic 1: Configuration UI Foundation.</snippet>
      </artifact>
    </docs>
    <code>
      <artifact>
        <path>src/components/config/ServerListItem.tsx</path>
        <kind>component</kind>
        <symbol>ServerListItem</symbol>
        <lines>1-31</lines>
        <reason>Existing component that displays server list items. WILL MODIFY to add isActive prop and conditional styling for active state (blue background/text).</reason>
      </artifact>
      <artifact>
        <path>src/components/config/Sidebar.tsx</path>
        <kind>component</kind>
        <symbol>Sidebar</symbol>
        <lines>1-54</lines>
        <reason>Parent component that renders server list. WILL MODIFY to accept selectedServerId, onSelectServer props and pass isActive/onClick to ServerListItem.</reason>
      </artifact>
      <artifact>
        <path>src/pages/ConfigPage.tsx</path>
        <kind>page</kind>
        <symbol>ConfigPage</symbol>
        <lines>1-38</lines>
        <reason>Top-level page component. WILL MODIFY to add selection state (selectedServerId, selectedGroupId) and handler functions (handleSelectServer, handleSelectGroup).</reason>
      </artifact>
      <artifact>
        <path>src/lib/utils.ts</path>
        <kind>utility</kind>
        <symbol>cn</symbol>
        <lines>4-6</lines>
        <reason>Utility function for conditional class merging using clsx and tailwind-merge. Use this for conditional styling in ServerListItem (active vs hover states).</reason>
      </artifact>
      <artifact>
        <path>src/services/api.ts</path>
        <kind>service</kind>
        <symbol>ServerData</symbol>
        <lines>unknown</lines>
        <reason>Interface defining server data structure (id, name, ip). Already imported in ConfigPage and Sidebar - maintain consistency.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <react>^18.2.0</react>
        <react-dom>^18.2.0</react-dom>
        <react-router-dom>^7.9.6</react-router-dom>
        <clsx>^2.1.1</clsx>
        <tailwind-merge>^3.4.0</tailwind-merge>
        <@radix-ui/react-scroll-area>^1.2.10</@radix-ui/react-scroll-area>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
- **State Management Pattern**: Manage selectedServerId and selectedGroupId in ConfigPage component (top-level page component). This enables future features (Epic 2) to access selection for form display. Pattern: Lift state up to common parent for shared access.
- **Mutual Exclusivity**: Selecting a server must clear group selection (setSelectedGroupId(null)), and vice versa. Only one item (server OR group) can be active at a time.
- **Visual Design Compliance**: Active state MUST use bg-blue-50 (#eff6ff) background and text-blue-600 (#2563eb) text per UX Design Specification section 7.1. Do not deviate from these exact colors.
- **Accessibility Requirements**: Active server item MUST have aria-current="true" attribute. Use role="list" for container and role="listitem" for items. Ensure Tab order follows visual hierarchy.
- **Component Modification Only**: This story ONLY modifies existing components (ConfigPage.tsx, Sidebar.tsx, ServerListItem.tsx). No new files should be created.
- **No Type Duplication**: ServerData interface is imported from api.ts - do not create duplicate type definitions.
- **Testing Approach**: Manual testing for Epic 1 (test infrastructure not set up). Follow testing checklist in story Dev Notes section.
- **Keyboard Navigation**: Start with simple approach (Option A from Dev Notes) - ServerListItem already has Enter/Space support from Story 1.3. Arrow key navigation is AC requirement but can be deferred if complex.
  </constraints>

  <interfaces>
    <interface>
      <name>ConfigPage → Sidebar props</name>
      <kind>React component props</kind>
      <signature>
interface SidebarProps {
  servers: ServerData[]
  isLoading: boolean
  error?: string | null
  selectedServerId: string | null      // NEW
  onSelectServer: (id: string) => void // NEW
}
      </signature>
      <path>src/components/config/Sidebar.tsx</path>
    </interface>
    <interface>
      <name>Sidebar → ServerListItem props</name>
      <kind>React component props</kind>
      <signature>
interface ServerListItemProps {
  server: { id: string; name: string; ip: string }
  isActive: boolean  // NEW
  onClick?: () => void
}
      </signature>
      <path>src/components/config/ServerListItem.tsx</path>
    </interface>
    <interface>
      <name>ConfigPage selection state</name>
      <kind>React state</kind>
      <signature>
const [selectedServerId, setSelectedServerId] = useState&lt;string | null&gt;(null)
const [selectedGroupId, setSelectedGroupId] = useState&lt;string | null&gt;(null)

const handleSelectServer = (id: string) => {
  setSelectedServerId(id)
  setSelectedGroupId(null)  // Clear group selection
}
      </signature>
      <path>src/pages/ConfigPage.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Manual testing approach for Epic 1 (React Testing Library + Vitest not yet configured). Follow WCAG 2.1 AA accessibility standards. Test keyboard navigation, focus states, and ARIA attributes using browser DevTools and accessibility inspector.</standards>
    <locations>No automated tests yet. Manual testing performed on development server at http://localhost:5173/config</locations>
    <ideas>
- AC1: Test clicking a server applies blue background (#eff6ff) and blue text (#2563eb)
- AC2: Test clicking server B deselects server A (mutual exclusivity within servers)
- AC3: Test active selection persists when clicking elsewhere on page (but not when navigating routes)
- AC4: Test Tab key focuses first server, Enter key selects it
- AC4: Test Arrow Down/Up navigates through server list (if implemented)
- AC5: Inspect DOM for aria-current="true" on active server item using browser DevTools
- AC5: Verify screen reader announces "current" state on active item (NVDA/VoiceOver)
- Edge case: Test with empty server list (no selection possible)
- Edge case: Test with single server (selection should still work)
- Edge case: Test rapid clicking (click multiple servers quickly) - should handle gracefully
    </ideas>
  </tests>
</story-context>

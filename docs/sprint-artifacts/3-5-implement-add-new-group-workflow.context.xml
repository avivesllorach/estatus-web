<story-context id="3-5-implement-add-new-group-workflow" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>5</storyId>
    <title>Implement Add New Group Workflow</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/arnau/estatus-web/docs/sprint-artifacts/3-5-implement-add-new-group-workflow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>click "+ Add Group" and create a new dashboard group</iWant>
    <soThat>I can organize my servers with custom groupings</soThat>
    <tasks>- [ ] Implement "+ Add Group" button functionality in sidebar (AC: 1)
  - [ ] Modify sidebar "+ Add Group" button click handler to set add mode
  - [ ] Update MainPanel to show "Add New Group" form when in add mode
  - [ ] Update PanelHeader title to "Add New Group" for add workflow

- [ ] Implement GroupForm initialization for add mode (AC: 2)
  - [ ] Add form mode detection (add vs edit) to GroupForm component
  - [ ] Set all form fields to empty values when in add mode
  - [ ] Auto-focus Group Name field when form loads in add mode
  - [ ] Calculate and set default Display Order to next available number (max existing order + 1)

- [ ] Implement save functionality for new groups (AC: 3, 4)
  - [ ] Create handleSaveNewGroup function in GroupForm component
  - [ ] Integrate with existing configApi.createGroup() function
  - [ ] Ensure form validation before making API call
  - [ ] Handle loading state during save operation

- [ ] Integrate success feedback and UI updates (AC: 5, 6)
  - [ ] Show success toast notification with green styling and 3-second auto-dismiss
  - [ ] Trigger groups list refresh in sidebar after successful creation
  - [ ] Clear form and reset to empty state for additional group creation
  - [ ] Update visual feedback in sidebar to show new group

- [ ] Implement error handling and validation feedback (AC: 7)
  - [ ] Show inline validation errors below Group Name field
  - [ ] Display error toast with specific failure reasons from API response
  - [ ] Configure red background styling for error toasts
  - [ ] Prevent save operation when validation errors exist</tasks>
  </story>

  <acceptanceCriteria>1. **Add Group Button Functionality**: When user clicks "+ Add Group" button in sidebar, the main panel shows "Add New Group" form with panel header title updated to "Add New Group"
2. **Form Initialization**: Form displays with empty fields: Group Name (required, auto-focus), Display Order (defaults to next available number), Assigned Servers (none selected initially)
3. **Save Operation**: When user clicks "Save Group", a POST request is sent to `/api/config/groups` with the new group data (name, order, serverIds)
4. **Backend Integration**: Backend validates the data, auto-generates group ID, appends to `dashboard-layout.json` atomically using temp file + rename pattern
5. **Success Feedback**: Success toast notification appears: "âœ“ Group created successfully" with green background (#dcfce7) and auto-dismisses after 3 seconds
6. **UI Updates**: New group appears in the sidebar list with correct name and server count (0 initially), and the form either clears for another add or loads the new group for editing
7. **Error Handling**: Validation errors show inline below fields and prevent save, error toast displays specific reason if save fails with red background that stays visible until dismissed</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Group Management</title>
        <section>Overview, Objectives and Scope, System Architecture Alignment, Detailed Design, APIs and Interfaces</section>
        <snippet>Complete CRUD operations for dashboard groups with server assignment interface and real-time updates. Groups stored in dashboard-layout.json with atomic file operations.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Estatus Web - Configuration UI Architecture</title>
        <section>System Overview, Data Architecture, Component Architecture, API Design, Real-Time Architecture</section>
        <snippet>Event-driven hot-reload using ConfigManager service. Group Management epic enables users to organize servers into dashboard groups with custom layouts.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>Configuration UI UX Design Specification</title>
        <section>Component Library, Custom Components, UX Pattern Decisions, Form Patterns</section>
        <snippet>shadcn/ui + Radix UI + Tailwind CSS component system. Group creation form with name, display order, and server assignment interface.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/components/groups/GroupForm.tsx</path>
        <kind>React Component</kind>
        <symbol>GroupForm</symbol>
        <lines>1-783</lines>
        <reason>Enhanced GroupForm component with comprehensive add/edit functionality, server assignment interface, and validation patterns ready for add workflow implementation</reason>
      </artifact>
      <artifact>
        <path>src/components/config/MainPanel.tsx</path>
        <kind>React Component</kind>
        <symbol>MainPanel</symbol>
        <lines>586-612</lines>
        <reason>MainPanel already integrated with GroupForm for edit mode, needs add mode integration for "+ Add Group" workflow</reason>
      </artifact>
      <artifact>
        <path>src/services/api.ts</path>
        <kind>API Service</kind>
        <symbol>configApi.createGroup</symbol>
        <lines>349-375</lines>
        <reason>Frontend API function for creating new groups with proper error handling and TypeScript types already implemented</reason>
      </artifact>
      <artifact>
        <path>backend/src/routes/config.ts</path>
        <kind>Express Route</kind>
        <symbol>POST /api/config/groups</symbol>
        <lines>124-231</lines>
        <reason>Backend API endpoint fully implemented with validation, atomic file writes, and comprehensive error handling for group creation</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="frontend">
        <package name="react" version="^18.2.0" />
        <package name="react-router-dom" version="^7.9.6" />
        <package name="@radix-ui/react-dialog" version="^1.1.15" />
        <package name="@radix-ui/react-toast" version="^1.2.15" />
        <package name="@radix-ui/react-checkbox" version="^1.3.3" />
        <package name="lucide-react" version="^0.554.0" />
        <package name="tailwindcss" version="^3.4.3" />
      </ecosystem>
      <ecosystem name="backend">
        <package name="express" version="latest" />
        <package name="typescript" version="latest" />
        <package name="fs/promises" version="built-in" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>Development Pattern</type>
      <rule>Use established form patterns from GroupForm component with React Hook Form state management and on-blur validation</rule>
      <source>GroupForm.tsx:115-126</source>
    </constraint>
    <constraint>
      <type>Validation Strategy</type>
      <rule>Implement defense-in-depth validation with frontend real-time feedback and backend comprehensive validation</rule>
      <source>GroupForm.tsx:285-320</source>
    </constraint>
    <constraint>
      <type>UI Consistency</type>
      <rule>Follow established toast notification patterns: green success with auto-dismiss (3s), red error with manual dismiss</rule>
      <source>GroupForm.tsx:358-374</source>
    </constraint>
    <constraint>
      <type>Data Persistence</type>
      <rule>Use atomic file write pattern (temp file + rename) for dashboard-layout.json updates</rule>
      <source>backend/src/routes/config.ts:202</source>
    </constraint>
    <constraint>
      <type>Group ID Generation</type>
      <rule>Auto-generate group IDs using "group-N" sequential pattern based on existing max ID</rule>
      <source>backend/src/routes/config.ts:178-188</source>
    </constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>POST /api/config/groups</name>
      <kind>REST API Endpoint</kind>
      <signature>POST /api/config/groups - Request: Omit&lt;GroupConfig, 'id'&gt; - Response: ApiResponse&lt;GroupConfig&gt;</signature>
      <path>backend/src/routes/config.ts:124-231</path>
    </interface>
    <interface>
      <name>configApi.createGroup</name>
      <kind>Frontend API Function</kind>
      <signature>createGroup(data: Omit&lt;GroupConfig, 'id'&gt;): Promise&lt;GroupConfig&gt;</signature>
      <path>src/services/api.ts:349-375</path>
    </interface>
    <interface>
      <name>GroupConfig</name>
      <kind>TypeScript Interface</kind>
      <signature>interface GroupConfig { id: string; name: string; order: number; serverIds: string[]; }</signature>
      <path>src/services/api.ts:253-258</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Unit tests for GroupForm component validation logic (validateGroup function). Integration tests for config API endpoints. Component testing with React Testing Library for form interactions and state management.</standards>
    <locations>Frontend: src/components/groups/__tests__/GroupForm.test.tsx. Backend: backend/src/tests/integration/config.test.ts. API: tests/integration/config-api.test.ts</locations>
    <ideas>
      <test for="AC1">Test "+ Add Group" button click triggers form display with "Add New Group" title</test>
      <test for="AC2">Test form initialization with empty fields and auto-focus on Group Name field</test>
      <test for="AC3-4">Test form submission sends POST request with correct data structure</test>
      <test for="AC5">Test success toast displays with green styling and 3-second auto-dismiss</test>
      <test for="AC6">Test new group appears in sidebar list and form clears for additional adds</test>
      <test for="AC7">Test validation errors show inline and prevent save operation</test>
    </ideas>
  </tests>
</story-context>
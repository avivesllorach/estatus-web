<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.5</storyId>
    <title>Build Collapsible NetApp Configuration Section</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-5-build-collapsible-netapp-configuration-section.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to expand a NetApp section to configure LUN monitoring</iWant>
    <soThat>I can enable NetApp integration with credentials and LUN paths</soThat>
    <tasks>
      - Task 1: Create NetAppConfigSection component with checkbox and basic fields (AC: 5, 6, 7, 8)
      - Task 2: Implement dynamic LUN Paths list (AC: 5)
      - Task 3: Wire NetAppConfigSection into MainPanel (AC: All)
      - Task 4: Add conditional enable/disable logic (AC: 6, 7)
      - Task 5: Test NetApp section behavior (AC: All)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Collapsible "NetApp Configuration" section appears below SNMP Configuration section
    2. Section collapsed by default (chevron points right ▶)
    3. Clicking header expands smoothly (200ms animation)
    4. When expanded, chevron rotates to point down (▼)
    5. Expanded section contains: Enable checkbox, API Type dropdown (REST/ZAPI), Username, Password (masked), LUN Paths dynamic list with Add/Remove
    6. NetApp fields only enabled when checkbox is checked
    7. Password field shows masked characters (type="password")
    8. Pre-populated with existing NetApp config if server has it
    9. Uses shadcn/ui Collapsible component (reuses CollapsibleConfigSection from Story 2.4)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 2.5" snippet="Build collapsible NetApp section with enable/disable checkbox, API Type select dropdown (REST, ZAPI), credentials, and dynamic LUN paths list with add/remove functionality. Reuses CollapsibleConfigSection from Story 2.4." />
      <doc path="docs/architecture.md" title="Architecture" section="Data Architecture" snippet="NetAppConfig schema: enabled (boolean), apiType ('rest' | 'zapi'), username, password, luns array with path property. Saved to backend/servers.json." />
      <doc path="docs/architecture.md" title="Architecture" section="Component Architecture" snippet="Frontend uses shadcn/ui components (Checkbox, Select, Input, Button) with Tailwind CSS styling. Collapsible sections reduce visual clutter while maintaining accessibility." />
      <doc path="docs/ux-design-specification.md" title="UX Design" section="Design System" snippet="shadcn/ui + Radix UI components provide accessibility built-in (keyboard navigation, ARIA labels, focus management). Neutral color palette with blue primary (#2563eb), gray background (#fafafa), destructive red (#dc2626)." />
      <doc path="docs/prd.md" title="Product Requirements" section="FR19-FR25" snippet="NetApp Configuration requirements: enable/disable monitoring, select API type (REST/ZAPI), configure credentials, define multiple LUN paths, add/remove LUNs, expand/collapse section." />
    </docs>

    <code>
      <file path="src/types/server.ts" kind="types" symbol="NetAppConfig" lines="19-25" reason="Existing type definition for NetApp configuration - must match this interface (enabled, apiType, username, password, luns array)" />
      <file path="src/types/server.ts" kind="types" symbol="LunConfig" lines="14-17" reason="Existing type for LUN configuration - includes name and path properties" />
      <file path="src/components/config/forms/shared/CollapsibleConfigSection.tsx" kind="component" symbol="CollapsibleConfigSection" lines="1-47" reason="Reusable collapsible wrapper component created in Story 2.4 - use as-is to wrap NetApp section (handles chevron rotation, 200ms animation, accessibility)" />
      <file path="src/components/config/forms/shared/FormGroup.tsx" kind="component" symbol="FormGroup" lines="1-47" reason="Reusable form field wrapper component - provides consistent label, error handling, helper text, and accessibility (aria-invalid, aria-describedby)" />
      <file path="src/components/config/MainPanel.tsx" kind="component" symbol="MainPanel" reason="Main panel component where NetApp section must be added below SNMP section - manages formValues state for all server config fields" />
      <file path="src/components/config/forms/server/SNMPConfigSection.tsx" kind="component" symbol="SNMPConfigSection" reason="Similar pattern to follow - checkbox controls enabled state, dynamic array with add/remove, conditional disable styling, parent callback for state updates" />
    </code>

    <dependencies>
      <node>
        <package name="react" version="^18.2.0" />
        <package name="react-dom" version="^18.2.0" />
        <package name="typescript" version="^5.2.2" />
        <package name="@radix-ui/react-checkbox" version="^1.3.3" />
        <package name="@radix-ui/react-collapsible" version="^1.1.12" />
        <package name="@radix-ui/react-select" version="^2.2.6" />
        <package name="lucide-react" version="^0.554.0" />
        <package name="tailwindcss" version="^3.4.3" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - Must reuse existing CollapsibleConfigSection component from Story 2.4 (do not recreate)
    - Must match NetAppConfig and LunConfig type definitions in src/types/server.ts exactly
    - Follow same state management pattern as SNMPConfigSection (local state + onChange callback to parent)
    - Use shadcn/ui components: Checkbox, Select, Input, Button
    - Apply conditional disable styling: bg-gray-100, cursor-not-allowed when !enabled
    - Password input must maintain type="password" regardless of enabled state
    - Use lucide-react icons: X for remove buttons, Plus for add button
    - FormGroup component provides labels and error handling - use for all fields except checkbox
    - Component file location: src/components/config/forms/server/NetAppConfigSection.tsx
    - Add NetApp section below SNMP section in MainPanel.tsx
    - Collapsed by default (defaultOpen={false})
  </constraints>

  <interfaces>
    <interface name="NetAppConfigSectionProps" kind="component-props" signature="{ netappConfig?: NetAppConfig; onChange: (config: NetAppConfig) => void }" path="src/components/config/forms/server/NetAppConfigSection.tsx" />
    <interface name="NetAppConfig" kind="type" signature="{ enabled: boolean; apiType?: 'rest' | 'zapi'; username: string; password: string; luns: LunConfig[] }" path="src/types/server.ts" />
    <interface name="LunConfig" kind="type" signature="{ name: string; path: string }" path="src/types/server.ts" />
    <interface name="CollapsibleConfigSection" kind="component" signature="(props: { title: string; defaultOpen?: boolean; children: ReactNode }) => JSX.Element" path="src/components/config/forms/shared/CollapsibleConfigSection.tsx" />
    <interface name="FormGroup" kind="component" signature="(props: { label: string; required?: boolean; children: ReactElement; error?: string | null; helperText?: string; htmlFor?: string }) => JSX.Element" path="src/components/config/forms/shared/FormGroup.tsx" />
  </interfaces>

  <tests>
    <standards>
      Testing follows manual verification approach per Story 2.4 pattern. Build verification ensures TypeScript compilation without errors (npm run build). Manual testing validates all acceptance criteria including collapsible behavior, enable/disable logic, dynamic LUN list, password masking, and pre-population.
    </standards>

    <locations>
      Build verification: npm run build (root directory)
      Manual testing: Navigate to /config route in running application
    </locations>

    <ideas>
      AC1: Verify NetApp section appears below SNMP section when viewing server form
      AC2-4: Test collapsible behavior - default collapsed state, smooth 200ms expansion, chevron rotation
      AC5: Verify all fields present - Enable checkbox, API Type dropdown with REST/ZAPI options, Username/Password inputs, LUN Paths dynamic list
      AC6: Test conditional enable/disable - uncheck checkbox, verify all fields disabled with gray background
      AC7: Verify password field shows masked characters (••••••••) when typing
      AC8: Select server with existing NetApp config, verify fields pre-populated with correct values
      AC9: Verify CollapsibleConfigSection component is reused (not recreated)
      Integration: Add LUN path, verify appears in list. Remove LUN path, verify removed from list. Enter credentials, verify state updates parent component.
      TypeScript: Build project, verify zero compilation errors for NetApp types and component
    </ideas>
  </tests>
</story-context>

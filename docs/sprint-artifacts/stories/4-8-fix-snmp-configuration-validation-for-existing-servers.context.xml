<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>8</storyId>
    <title>Fix SNMP Configuration Validation for Existing Servers</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/arnau/estatus-web/docs/sprint-artifacts/4-8-fix-snmp-configuration-validation-for-existing-servers.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to add SNMP configuration to an existing server that was created without SNMP settings</iWant>
    <soThat>I can enable monitoring on previously configured servers without recreation</soThat>
    <tasks>- [ ] Task 1: Analyze and fix backend SNMP validation logic (AC: 1, 2, 4, 5)
  - [ ] Subtask 1.1: Review current validation logic in `backend/src/utils/validation.ts`
  - [ ] Subtask 1.2: Fix SNMP validation to handle missing/undefined `snmpConfig` objects
  - [ ] Subtask 1.3: Add comprehensive validation for partial SNMP configurations
  - [ ] Subtask 1.4: Update validation error messages for clarity
  - [ ] Subtask 1.5: Add unit tests for SNMP validation edge cases

- [ ] Task 2: Ensure frontend SNMP form handles existing server state (AC: 3, 6)
  - [ ] Subtask 2.1: Test current SNMPConfigSection behavior with existing servers
  - [ ] Subtask 2.2: Fix form initialization when SNMP is added to existing servers
  - [ ] Subtask 2.3: Ensure proper state management during SNMP enable/disable transitions
  - [ ] Subtask 2.4: Add integration tests for frontend-backend SNMP configuration flow

- [ ] Task 3: Test complete SNMP configuration workflow (AC: 1, 6)
  - [ ] Subtask 3.1: Create test scenarios for adding SNMP to existing servers
  - [ ] Subtask 3.2: Test validation with various SNMP configuration states
  - [ ] Subtask 3.3: Verify error handling and user feedback
  - [ ] Subtask 3.4: Perform regression testing on existing SNMP functionality

- [ ] Task 4: Update documentation and add validation coverage (AC: 5)
  - [ ] Subtask 4.1: Document SNMP configuration validation rules
  - [ ] Subtask 4.2: Add SNMP validation test cases to test suite
  - [ ] Subtask 4.3: Update error message documentation</tasks>
  </story>

  <acceptanceCriteria>1. [AC-1] Users can add SNMP configuration to existing servers that were created without SNMP settings
2. [AC-2] Backend validation properly handles missing or incomplete `snmpConfig` objects
3. [AC-3] Frontend form correctly initializes when SNMP config is added to existing servers
4. [AC-4] All existing SNMP validation rules remain enforced when SNMP is enabled
5. [AC-5] Error messages provide clear feedback about validation failures
6. [AC-6] Both frontend and backend handle the SNMP configuration state transition seamlessly</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/prd.md" title="Product Requirements Document" section="Form Validation & Error Handling" snippet="FR51-FR58: Form validation patterns including required fields, IP format validation, ID uniqueness, inline validation errors, and backend 400 responses with detailed error messages."/>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Epic 2: Server Management" snippet="Epic 2 covers complete CRUD operations for servers with SNMP and NetApp configuration, validation patterns, and error handling. Story 2.4 specifically implements SNMP configuration section with collapsible interface."/>
      <doc path="docs/architecture.md" title="Architecture Document" section="API Design" snippet="New API endpoints: /api/config/servers with defense-in-depth validation (frontend UX + backend security). Atomic file writes with temp+rename pattern for data integrity."/>
    </docs>
    <code>
      <artifact path="backend/src/utils/validation.ts" kind="validation" symbol="validateServerConfig" lines="67-80" reason="Primary location of SNMP validation logic that has issues handling missing snmpConfig objects when servers are created without SNMP settings"/>
      <artifact path="src/components/config/forms/server/SNMPConfigSection.tsx" kind="component" symbol="SNMPConfigSection" lines="15-50" reason="Frontend SNMP configuration form component that needs to handle existing server state when SNMP is added to servers without prior SNMP config"/>
      <artifact path="src/types/server.ts" kind="types" symbol="SnmpConfig" lines="8-13" reason="Type definition for SNMP configuration structure, shows enabled field, community string, storage indexes array, and optional disk configurations"/>
      <artifact path="backend/src/routes/servers.ts" kind="api" symbol="createServerRoutes" lines="1-50" reason="API routes for server configuration - likely needs to be extended for config management endpoints that handle SNMP state transitions"/>
    </code>
    <dependencies>
      <framework name="React" version="18.2.0"/>
      <framework name="TypeScript" version="5.2.2"/>
      <framework name="Express.js" version="unknown"/>
      <framework name="shadcn/ui" version="unknown"/>
      <framework name="Radix UI" version="1.x"/>
      <framework name="Tailwind CSS" version="3.4.3"/>
      <framework name="Lucide React" version="0.554.0"/>
    </dependencies>
  </artifacts>

  <constraints>
  <constraint type="validation">Defense-in-depth validation strategy with both frontend and backend checks</constraint>
  <constraint type="state">React state management for form components with proper parent updates during SNMP enable/disable transitions</constraint>
  <constraint type="api">RESTful server configuration endpoints with comprehensive validation and consistent error response format</constraint>
  <constraint type="data">SNMP validation must handle missing/undefined snmpConfig objects gracefully</constraint>
  <constraint type="transition">Frontend form must correctly initialize when SNMP config is added to existing servers without prior SNMP settings</constraint>
  <constraint type="error">Clear error messages required for validation failures with specific guidance</constraint>
</constraints>
  <interfaces>
  <interface name="SnmpConfig" kind="interface" signature="interface SnmpConfig { enabled: boolean; community: string; storageIndexes: number[]; disks?: DiskConfig[]; }" path="src/types/server.ts:8-13"/>
  <interface name="DiskConfig" kind="interface" signature="interface DiskConfig { index: number; name?: string; }" path="src/types/server.ts:3-6"/>
  <interface name="validateServerConfig" kind="function" signature="function validateServerConfig(config: ServerConfig): ValidationErrors" path="backend/src/utils/validation.ts"/>
  <interface name="SNMPConfigSectionProps" kind="interface" signature="interface SNMPConfigSectionProps { snmpConfig?: SnmpConfig; onChange: (config: SnmpConfig) => void; }" path="src/components/config/forms/server/SNMPConfigSection.tsx:10-13"/>
  <interface name="PUT /api/config/servers/:id" kind="REST endpoint" signature="PUT /api/config/servers/:id - Updates server configuration with validation" path="backend/src/routes/config.ts"/>
  <interface name="ServerConfig" kind="interface" signature="interface ServerConfig { id: string; name: string; ip: string; dns: string; snmpConfig?: SnmpConfig; netappConfig?: NetAppConfig; }" path="src/types/server.ts"/>
</interfaces>
  <tests>
    <standards>Unit tests for individual validation functions with various input states, integration tests for complete SNMP configuration workflow, frontend tests for form behavior and state management, backend tests for API validation and error responses, and regression tests to ensure existing SNMP functionality remains intact.</standards>
    <locations>backend/src/__tests__/utils/validation.test.ts for SNMP validation edge cases, backend/src/__tests__/routes/config.test.ts for API endpoint validation, src/components/config/forms/server/__tests__/SNMPConfigSection.test.tsx for frontend form behavior, and integration tests for end-to-end SNMP configuration workflow.</locations>
    <ideas>
      <test idea="AC-1">Test adding SNMP configuration to server created without SNMP settings - verify backend accepts and saves SNMP config properly</test>
      <test idea="AC-2">Test SNMP validation with missing/undefined snmpConfig objects - verify validation handles undefined cases gracefully</test>
      <test idea="AC-3">Test SNMPConfigSection initialization with existing server that has no prior SNMP config - verify form loads correctly without errors</test>
      <test idea="AC-4">Test that existing SNMP validation rules remain enforced - verify all validation rules still apply when SNMP is enabled</test>
      <test idea="AC-5">Test error message clarity for validation failures - verify error messages provide specific guidance about what failed</test>
      <test idea="AC-6">Test complete frontend-backend SNMP configuration workflow - verify state transitions work seamlessly</test>
      <test idea="Edge Case">Test partial SNMP configuration objects during transition - verify validation handles incomplete SNMP objects</test>
      <test idea="Regression">Test existing SNMP functionality to ensure no breaking changes</test>
    </ideas>
  </tests>
</story-context>
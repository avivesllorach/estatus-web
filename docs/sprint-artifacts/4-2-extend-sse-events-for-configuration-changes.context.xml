<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>2</storyId>
    <title>Extend SSE Events for Configuration Changes</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-2-extend-sse-events-for-configuration-changes.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>backend service</asA>
    <iWant>broadcast configuration change events via SSE</iWant>
    <soThat>all connected dashboards can update in real-time</soThat>
    <tasks>- [ ] Extend SSE event types for configuration changes (AC: 1-4)
  - [ ] Add serverAdded event type with full server object
  - [ ] Add serverUpdated event type with full server object
  - [ ] Add serverRemoved event type with serverId only
  - [ ] Add groupsChanged event type with full groups array
- [ ] Integrate SSE broadcasting with config endpoints (AC: 1, 2, 3, 4)
  - [ ] Add SSE broadcast after successful server creation (POST /api/config/servers)
  - [ ] Add SSE broadcast after successful server update (PUT /api/config/servers/:id)
  - [ ] Add SSE broadcast after successful server deletion (DELETE /api/config/servers/:id)
  - [ ] Add SSE broadcast after successful group operations (POST/PUT/DELETE /api/config/groups)
- [ ] Ensure SSE endpoint compatibility (AC: 5)
  - [ ] Verify events work with existing `/api/events` endpoint
  - [ ] Maintain backward compatibility with existing event types
- [ ] Test multi-client broadcasting (AC: 6)
  - [ ] Test events reach all connected clients
  - [ ] Test with mixed dashboard and config page clients
  - [ ] Verify no clients are missed during broadcasts</tasks>
  </story>

  <acceptanceCriteria>1. **Given** the backend has successfully updated configuration
**When** a server is added
**Then** the backend broadcasts SSE event: `{ type: 'serverAdded', server: {...} }`

2. **And** when a server is updated
**Then** the backend broadcasts SSE event: `{ type: 'serverUpdated', server: {...} }`

3. **And** when a server is deleted
**Then** the backend broadcasts SSE event: `{ type: 'serverRemoved', serverId: '...' }`

4. **And** when groups are changed
**Then** the backend broadcasts SSE event: `{ type: 'groupsChanged', groups: [...] }`

5. **And** these events are sent to the existing `/api/events` SSE endpoint

6. **And** events are sent to ALL connected clients (dashboard and config pages)</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="System Architecture and SSE Design" section="SSE Event Stream Extensions" snippet="New config events added to existing /api/events stream: serverAdded, serverRemoved, serverUpdated, groupsChanged with full server/group objects for precise UI updates" />
      <doc path="docs/architecture.md" title="Multi-Client Synchronization Architecture" section="Real-Time Architecture" snippet="SSE events broadcast to all connected clients - dashboard and config pages - for configuration synchronization across multiple browser sessions" />
      <doc path="docs/epics.md" title="Epic 4 Live Configuration Updates" section="Story 4.2" snippet="Broadcast configuration change events via SSE to all connected dashboards with new event types for serverAdded, serverUpdated, serverRemoved, groupsChanged" />
      <doc path="docs/prd.md" title="Multi-Client Synchronization Requirements" section="Real-Time Configuration Updates" snippet="FR46-FR50: System broadcasts configuration changes via SSE to all connected dashboard clients, FR66-FR69: Multi-client sync requirements" />
    </docs>
    <code>
      <artifact path="backend/src/routes/events.ts" kind="route" symbol="createEventsRoute" lines="55-74" reason="Existing SSE infrastructure already has ConfigManager event listeners for servers-changed and groups-changed events" />
      <artifact path="backend/src/routes/events.ts" kind="route" symbol="SSE event broadcasting" lines="56-70" reason="Shows how to broadcast different event types - need to update to use serverAdded/serverUpdated/serverRemoved format per architecture" />
      <artifact path="backend/src/services/ConfigManager.ts" kind="service" symbol="ConfigManager" lines="104-120" reason="Emits servers-added/servers-removed/servers-updated events with delta information - matches story requirements" />
      <artifact path="backend/src/services/ConfigManager.ts" kind="service" symbol="reloadServers" lines="112-120" reason="Already emits specific server change events - need to map these to SSE format" />
      <artifact path="backend/src/services/ConfigManager.ts" kind="service" symbol="reloadGroups" lines="175-178" reason="Already emits groups-changed events - SSE handler already processes this" />
      <artifact path="backend/src/routes/config.ts" kind="route" symbol="config CRUD endpoints" lines="1-100" reason="POST/PUT/DELETE endpoints exist - need to trigger ConfigManager.reload() after successful operations" />
    </code>
    <dependencies>
      <framework name="Node.js" version="18+" />
      <framework name="Express.js" version="Latest" />
      <framework name="TypeScript" version="Latest" />
      <framework name="React" version="18.2.0" />
      <library name="EventEmitter" purpose="Built-in Node.js event system for ConfigManager" />
    </dependencies>
  </artifacts>

  <constraints>
      - Must maintain backward compatibility with existing SSE event types (statusChange, diskUpdate, heartbeat)
      - Events must broadcast to ALL connected clients, not just the requesting client
      - Only broadcast after successful atomic file writes - never on failed operations
      - Use existing ConfigManager event system rather than direct SSE calls from config endpoints
      - Event format must match architecture specification: serverAdded with full object, serverRemoved with serverId only
      - SSE connection must remain stable during configuration changes (no reconnects)
    </constraints>
  <interfaces>
      <interface name="SSE Event Broadcasting" kind="Server-Sent Events" signature="res.write(`data: ${JSON.stringify({type: 'serverAdded', server: ServerConfig})}\\n\\n`)" path="backend/src/routes/events.ts" />
      <interface name="ConfigManager Events" kind="EventEmitter" signature="configManager.emit('servers-changed', {servers: ServerConfig[], delta: {added, removed, updated}, timestamp: Date})" path="backend/src/services/ConfigManager.ts" />
      <interface name="Config CRUD Endpoints" kind="REST API" signature="POST/PUT/DELETE /api/config/servers/:id, POST/PUT/DELETE /api/config/groups/:id" path="backend/src/routes/config.ts" />
    </interfaces>
  <tests>
    <standards>Use integration tests for SSE broadcasting - test actual EventSource connections and real-time message delivery. Follow existing ApiResponse<T> patterns for backend responses. Test event format matches architecture specification exactly.</standards>
    <locations>backend/src/routes/__tests__/events.test.ts (create), backend/src/services/__tests__/ConfigManager.test.ts (extend)</locations>
    <ideas>
      <test idea="AC1-4" title="SSE Event Format Verification">Test that ConfigManager events are broadcast in correct SSE format: serverAdded with full object, serverUpdated with full object, serverRemoved with serverId only, groupsChanged with full array</test>
      <test idea="AC6" title="Multi-Client Broadcasting">Test with multiple EventSource clients - ensure all clients receive configuration events, not just the requesting client</test>
      <test idea="AC5" title="Backward Compatibility">Test that existing SSE event types (statusChange, diskUpdate, heartbeat) continue working alongside new config events</test>
      <test idea="Integration" title="Config Endpoint Integration">Test that POST/PUT/DELETE operations trigger appropriate SSE events through ConfigManager.reload() calls</test>
    </ideas>
  </tests>
</story-context>